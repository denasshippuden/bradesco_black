<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel Black-List</title>
  <style>
    :root {
      --panel: rgba(13, 18, 26, 0.75);
      --panel-border: rgba(255, 255, 255, 0.1);
      --accent: #5ea4ff;
      --accent-2: #e2435a;
      --text: #e8edf2;
      --muted: #b5c2d4;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Segoe UI", sans-serif;
      color: var(--text);
      position: relative;
      overflow: hidden;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image: url("assets/login-bg.png");
      background-size: cover;
      background-position: center;
      z-index: -2;
      transition: background-image 200ms ease-in-out;
    }
    body.dashboard::before {
      background-image: url("assets/dashboard-bg.png");
    }
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.28);
      z-index: -1;
    }
    .page {
      display: grid;
      grid-template-columns: 45% 55%;
      min-height: 100vh;
    }
    .left { padding: 32px 40px; }
    .right {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 64px 56px;
    }
    .right::before {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.18);
      transition: opacity 200ms ease;
      z-index: 0;
    }
    body.dashboard .right::before { opacity: 0.45; }
    .panel {
      position: relative;
      z-index: 1;
      width: min(480px, 100%);
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 18px 50px rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .panel.login-panel {
      background: rgba(255, 255, 255, 0.16);
      border-color: rgba(255, 255, 255, 0.28);
      color: #f7f9fb;
    }
    .panel.dashboard-panel {
      background: rgba(14, 16, 24, 0.9);
      border-color: rgba(255, 255, 255, 0.06);
    }
    .dashboard-title {
      position: absolute;
      top: 10px;
      right: 14px;
      font-size: 26px;
      font-weight: 800;
      color: #f5f7fb;
      text-shadow: 0 2px 14px rgba(0, 0, 0, 0.4);
      opacity: 0;
      transform: translateY(-6px);
      transition: opacity 200ms ease, transform 200ms ease;
      z-index: 3;
      text-align: right;
    }
    body.dashboard .dashboard-title {
      opacity: 1;
      transform: translateY(0);
    }
    .actions-wrap {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      justify-content: center;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 200ms ease, transform 200ms ease;
    }
    body.dashboard .actions-wrap {
      opacity: 1;
      transform: translateY(0);
    }
    .eagle-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 18px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(255, 255, 255, 0.12);
      color: #f7f9fb;
      cursor: pointer;
      backdrop-filter: blur(6px);
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.35);
      transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease, border-color 120ms ease;
    }
    .eagle-btn:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, 0.16);
      border-color: rgba(255, 255, 255, 0.26);
      box-shadow: 0 18px 36px rgba(0, 0, 0, 0.4);
    }
    .eagle-btn img {
      width: 120px;
      height: auto;
      object-fit: contain;
      filter: drop-shadow(0 10px 18px rgba(0, 0, 0, 0.35));
    }
    .eagle-btn span {
      font-weight: 800;
      letter-spacing: 0.02em;
    }
    h1, h2 {
      margin: 0 0 10px;
      font-weight: 700;
    }
    h1 { font-size: 26px; }
    h2 { font-size: 18px; color: var(--accent); }
    label {
      display: block;
      margin: 12px 0 6px;
      color: var(--muted);
      font-size: 14px;
    }
    input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      outline: none;
    }
    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(94, 164, 255, 0.18);
    }
    .panel.login-panel input {
      background: #ffffff;
      color: #3b4252;
      border: 1px solid #d9dfe8;
      border-radius: 999px;
      padding: 14px 16px;
    }
    .panel.login-panel input::placeholder { color: #8a93a3; }
    .btn {
      width: 100%;
      padding: 12px 14px;
      margin-top: 16px;
      border: none;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent), #3d7ed9);
      color: #0b1220;
      font-weight: 700;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
    }
    .panel.login-panel .btn {
      background: linear-gradient(135deg, #2b86f5, #1c6dd4);
      color: #ffffff;
      letter-spacing: 0.02em;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 30px rgba(94, 164, 255, 0.35); }
    .btn:active { transform: translateY(0); }
    .muted {
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
    }
    .login-feedback {
      margin-top: 10px;
      color: #e2435a;
      font-size: 13px;
      min-height: 18px;
    }
    .chip {
      display: inline-block;
      padding: 6px 11px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.12);
      font-size: 11px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 14px;
    }
    .actions {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-top: 4px;
    }
    .actions-panel {
      width: min(480px, 90vw);
      background: rgba(20, 26, 36, 0.82);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 18px 18px 20px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(8px);
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transform: translateY(-6px);
      transition: max-height 200ms ease, opacity 200ms ease, transform 200ms ease;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .actions-wrap.open .actions-panel {
      max-height: 600px;
      opacity: 1;
      transform: translateY(0);
      overflow: visible;
    }
    .action-btn {
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(255, 255, 255, 0.12);
      color: var(--text);
      cursor: pointer;
      text-align: left;
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
    }
    .action-btn strong { display: block; margin-bottom: 6px; font-size: 16px; }
    .action-btn span { color: var(--muted); font-size: 13px; }
    .action-btn:hover {
      transform: translateY(-2px);
      border-color: rgba(94, 164, 255, 0.5);
      background: rgba(255, 255, 255, 0.18);
    }
    .consult-card {
      padding: 16px 16px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(30, 34, 48, 0.8));
      box-shadow: 0 14px 32px rgba(0, 0, 0, 0.35);
    }
    .consult-card h2 { margin: 0 0 4px; color: #f7f9fb; }
    .consult-card .muted { margin: 0 0 10px; display: block; }
    .consult-row {
      display: grid;
      grid-template-columns: 1fr 150px;
      gap: 10px;
      align-items: center;
      margin-top: 4px;
    }
    .consult-row input {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.16);
      color: var(--text);
    }
    .consult-btn {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: linear-gradient(135deg, #ff6f61, #f5405c);
      color: #0b1220;
      font-weight: 800;
      cursor: pointer;
      letter-spacing: 0.01em;
      transition: transform 120ms ease, box-shadow 120ms ease, filter 120ms ease;
    }
    .consult-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(245, 64, 92, 0.35);
      filter: saturate(1.05);
    }
    .consult-btn:active { transform: translateY(0); }
    .consult-feedback {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text);
      font-weight: 700;
      text-align: center;
    }
    .consult-feedback.is-success {
      border-color: rgba(90, 214, 134, 0.8);
      background: rgba(90, 214, 134, 0.15);
      color: #e8fff2;
    }
    .consult-feedback.is-error {
      border-color: rgba(226, 67, 90, 0.8);
      background: rgba(226, 67, 90, 0.12);
      color: #ffe6ec;
    }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity 180ms ease;
    }
    .modal-backdrop.active {
      opacity: 1;
      pointer-events: all;
    }
    .modal {
      width: min(460px, 90vw);
      background: rgba(255, 255, 255, 0.96);
      color: #0f1726;
      border-radius: 14px;
      padding: 22px 24px;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(0, 0, 0, 0.04);
    }
    .modal h3 {
      margin: 0 0 8px;
      font-size: 20px;
      font-weight: 800;
    }
    .modal p { margin: 0 0 10px; line-height: 1.6; }
    .modal button {
      margin-top: 8px;
      border: none;
      padding: 10px 12px;
      border-radius: 8px;
      background: #0f1726;
      color: #f5f7fb;
      cursor: pointer;
      width: 100%;
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    .page-footer {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 24px;
      background: linear-gradient(180deg, transparent 0%, rgba(0, 0, 0, 0.45) 100%);
      color: var(--text);
      gap: 12px;
      flex-wrap: wrap;
      z-index: 5;
    }
    .ghost {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.22);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      cursor: pointer;
      transition: border-color 120ms ease, background 120ms ease;
    }
    .ghost:hover {
      border-color: var(--accent);
      background: rgba(255, 255, 255, 0.1);
    }
    small { color: var(--muted); }
    .hidden { display: none; }
    @media (max-width: 960px) {
      .page { grid-template-columns: 1fr; }
      .left { padding: 28px; justify-content: center; }
      .right { min-height: 60vh; padding: 32px 24px; }
      .panel { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="page">
    <section class="left"></section>
    <section class="right">
      <div class="dashboard-title" id="dashboard-title">Black-List Bradesco Vida</div>
      <div class="panel login-panel" id="login-card">
        <h1>Login</h1>
        <form id="login-form">
          <label for="user">Usu&aacute;rio</label>
          <input id="user" name="user" type="text" placeholder="Digite seu usu&aacute;rio" required>
          <label for="pass">Senha</label>
          <input id="pass" name="pass" type="password" placeholder="Digite sua senha" required>
          <button class="btn" type="submit">Entrar</button>
          <div class="login-feedback hidden" id="login-feedback"></div>
        </form>
      </div>

      <div class="actions-wrap hidden" id="actions-wrap">
        <button class="eagle-btn" id="toggle-actions" type="button">
          <img src="assets/ave.png" alt="Am&eacute;rica Financeira">
          <span>Black-List Bradesco Vida</span>
        </button>
        <div class="actions-panel" id="dashboard-panel">
          <div class="actions">
            <button class="action-btn" id="btn-add">
              <strong>Adicionar a Black-List</strong>
              <span>Importa CPFs para a tabela BlackList.</span>
            </button>
            <button class="action-btn" id="btn-export">
              <strong>Extrair Black-List</strong>
              <span>Exporta os dados armazenados.</span>
            </button>
            <button class="action-btn" id="btn-clean">
              <strong>Limpar Mailing, Black-List</strong>
              <span>Remove CPFs presentes na BlackList de sua planilha.</span>
            </button>
          </div>
          <div class="consult-card">
            <h2>Consulta Vida</h2>
            <span class="muted">Verifique se o CPF esta na Black-List.</span>
            <div class="consult-row">
              <input
                id="cpf-check-input"
                type="text"
                inputmode="numeric"
                autocomplete="off"
                placeholder="Digite o CPF"
                maxlength="14"
              >
              <button class="consult-btn" type="button" id="btn-consult">Consulta Vida</button>
            </div>
            <div class="consult-feedback hidden" id="consult-feedback"></div>
          </div>
        </div>
      </div>
    </section>
  </div>
  <div class="modal-backdrop hidden" id="modal-backdrop">
    <div class="modal">
      <h3 id="modal-title"></h3>
      <div id="modal-body"></div>
      <button id="modal-close">Fechar</button>
    </div>
  </div>
  <footer class="page-footer">
    <button class="ghost" id="btn-terms">Termos de uso</button>
    <small>Feito por Andr&eacute; Galante</small>
  </footer>
      <script>
    const API_BASE = window.API_BASE || "";
    const apiUrl = (path) =>
      `${API_BASE}`.replace(/\/$/, "") + path;
    const form = document.getElementById("login-form");
    const loginCard = document.getElementById("login-card");
    const actionsWrap = document.getElementById("actions-wrap");
    const loginFeedback = document.getElementById("login-feedback");
    const loginButton = form.querySelector('button[type="submit"]');
    const dashboardTitle = document.getElementById("dashboard-title");
    const consultInput = document.getElementById("cpf-check-input");
    const consultFeedback = document.getElementById("consult-feedback");
    const consultButton = document.getElementById("btn-consult");
    let authToken = "";

    const authHeaders = () =>
      authToken ? { Authorization: `Bearer ${authToken}` } : {};
    const ensureLoggedIn = () => {
      if (!authToken) {
        throw new Error("Sessao expirada, faca login novamente.");
      }
    };

    const setDashboardVisible = () => {
      loginCard.classList.add("hidden");
      actionsWrap.classList.remove("hidden");
      document.body.classList.add("dashboard");
      dashboardTitle.classList.remove("hidden");
    };

    const setLoginFeedback = (message = "") => {
      loginFeedback.textContent = message;
      loginFeedback.classList.toggle("hidden", !message);
    };

    const setConsultFeedback = (message = "", variant = "") => {
      if (!consultFeedback) return;
      consultFeedback.textContent = message;
      consultFeedback.classList.toggle("hidden", !message);
      consultFeedback.classList.toggle("is-success", variant === "success");
      consultFeedback.classList.toggle("is-error", variant === "error");
    };

    const buildHttpError = async (res, fallback) => {
      let data = null;
      try {
        data = await res.clone().json();
      } catch (_) {
        /* ignore parse errors */
      }
      const msg =
        (data && (data.error || data.message)) ||
        fallback ||
        (res.status ? `Erro ${res.status} - ${res.statusText || ""}` : "Erro inesperado.");
      const error = new Error(msg);
      error.status = res.status;
      error.body = data;
      return error;
    };

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      setLoginFeedback("");
      const payload = {
        user: form.user.value.trim(),
        pass: form.pass.value,
      };

      if (!payload.user || !payload.pass) {
        setLoginFeedback("Informe usuario e senha.");
        return;
      }

      loginButton.disabled = true;
      loginButton.textContent = "Entrando...";
      try {
        const res = await fetch(apiUrl("/api/login"), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw await buildHttpError(res, "Nao foi possivel fazer login.");
        }

        if (!data.token) {
          throw new Error("Resposta de login invalida.");
        }

        authToken = data.token;
        setDashboardVisible();
      } catch (err) {
        setLoginFeedback(err.message || "Falha ao fazer login.");
      } finally {
        loginButton.disabled = false;
        loginButton.textContent = "Entrar";
      }
    });

    const modalBackdrop = document.getElementById("modal-backdrop");
    const modalTitle = document.getElementById("modal-title");
    const modalBody = document.getElementById("modal-body");
    const closeModal = () => {
      modalBackdrop.classList.remove("active");
      modalBackdrop.classList.add("hidden");
    };

    const openModal = (title, bodyHtml) => {
      modalTitle.textContent = title;
      modalBody.innerHTML = bodyHtml;
      modalBackdrop.classList.remove("hidden");
      modalBackdrop.classList.add("active");
    };

    document.getElementById("modal-close").addEventListener("click", closeModal);
    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) closeModal();
    });

    document.getElementById("toggle-actions").addEventListener("click", () => {
      actionsWrap.classList.toggle("open");
    });

    const createFileInput = () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".csv,text/csv";
      input.style.display = "none";
      document.body.appendChild(input);
      return input;
    };

    const fileInputs = {
      import: createFileInput(),
      clean: createFileInput(),
    };

    const pickFile = (key) =>
      new Promise((resolve, reject) => {
        const input = fileInputs[key];
        input.onchange = () => {
          const [file] = input.files;
          input.value = "";
          if (!file) return reject(new Error("Nenhum arquivo selecionado."));
          resolve(file);
        };
        input.click();
      });

    const downloadBlob = (blob, filename) => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

    const handleConsult = async () => {
      setConsultFeedback("");
      const raw = (consultInput?.value || "").trim();
      const cpf = raw.replace(/\D/g, "");
      if (!cpf) {
        setConsultFeedback("Informe o CPF.", "error");
        consultInput?.focus();
        return;
      }
      if (cpf.length !== 11) {
        setConsultFeedback("CPF invalido.", "error");
        consultInput?.focus();
        return;
      }

      if (consultButton) {
        consultButton.disabled = true;
        consultButton.textContent = "Consultando...";
      }
      try {
        ensureLoggedIn();
        const res = await fetch(apiUrl("/api/blacklist/check"), {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...authHeaders(),
          },
          body: JSON.stringify({ cpf }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw await buildHttpError(res, "Falha ao consultar CPF.");
        }
        const blacklisted = !!data.blacklisted;
        setConsultFeedback(
          blacklisted ? "Cliente na lista negra" : "Cliente disponivel",
          blacklisted ? "error" : "success"
        );
      } catch (err) {
        setConsultFeedback(err.message || "Falha na consulta.", "error");
      } finally {
        if (consultButton) {
          consultButton.disabled = false;
          consultButton.textContent = "Consulta Vida";
        }
      }
    };

    const handleImport = async () => {
      const file = await pickFile("import");
      const formData = new FormData();
      formData.append("file", file);
      ensureLoggedIn();
      const res = await fetch(apiUrl("/api/blacklist/import"), {
        method: "POST",
        headers: {
          ...authHeaders(),
        },
        body: formData,
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw await buildHttpError(res, "Falha ao importar Black-List.");
      }
      openModal(
        "Importar Black-List",
        `<p>Processados: ${data.processed ?? "-"}</p>
         <p>Inseridos: ${data.inserted ?? "-"}</p>
         <p>Duplicados: ${data.duplicates ?? "-"}</p>
         <p>Invalidos: ${data.invalid ?? "-"}</p>`
      );
    };

    const handleExport = async () => {
      ensureLoggedIn();
      const res = await fetch(apiUrl("/api/blacklist/export"), {
        headers: {
          ...authHeaders(),
        },
      });
      if (!res.ok) {
        throw await buildHttpError(res, "Falha ao exportar Black-List.");
      }
      const blob = await res.blob();
      downloadBlob(blob, "blacklist.csv");
      openModal("Exportar Black-List", "Arquivo exportado com sucesso.");
    };

    const handleClean = async () => {
      const file = await pickFile("clean");
      const formData = new FormData();
      formData.append("file", file);
      ensureLoggedIn();
      const res = await fetch(apiUrl("/api/blacklist/clean"), {
        method: "POST",
        headers: {
          ...authHeaders(),
        },
        body: formData,
      });
      if (!res.ok) {
        throw await buildHttpError(res, "Falha ao limpar mailing.");
      }
      const blob = await res.blob();
      const kept = res.headers.get("X-Records-Filtered");
      const total = res.headers.get("X-Records-Input");
      const removed =
        kept && total ? Math.max(Number(total) - Number(kept), 0) : null;
      downloadBlob(blob, "mailing_limpo.csv");
      openModal(
        "Mailing limpo",
        `Arquivo gerado com sucesso.<br>Recebidos: ${total || "-"}<br>Liberados: ${kept || "-"}${
          removed !== null ? `<br>Removidos da blacklist: ${removed}` : ""
        }`
      );
    };

    const termsCopy =
      "Aqui voce podera exibir os termos de uso completos da aplicacao.";

    const safely = (fn) => async () => {
      try {
        await fn();
      } catch (err) {
        openModal("Erro", err.message || "Algo deu errado.");
      }
    };

    document
      .getElementById("btn-add")
      .addEventListener("click", safely(handleImport));
    document
      .getElementById("btn-export")
      .addEventListener("click", safely(handleExport));
    document
      .getElementById("btn-clean")
      .addEventListener("click", safely(handleClean));
    if (consultButton) {
      consultButton.addEventListener("click", handleConsult);
    }
    if (consultInput) {
      consultInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          handleConsult();
        }
      });
    }
    document.getElementById("btn-terms").addEventListener("click", () => {
      openModal("Termos de uso", termsCopy);
    });
  </script>
</body>
</html>
